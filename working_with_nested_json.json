-- 1 - Load and query nexted author and book json data 

-- Create an Ingestion Table for the NESTED JSON Data
create or replace table library_card_catalog.public.nested_ingest_json 
(
  raw_nested_book VARIANT
);

-- Create File Format for JSON Data 
create or replace file format library_card_catalog.public.json_file_format
type = 'JSON' 
compression = 'AUTO' 
enable_octal = FALSE
allow_duplicate = FALSE 
strip_outer_array = TRUE --to ignore the square brackets and load each author into a separate row
strip_null_values = FALSE 
ignore_utf8_errors = FALSE; 

-- See the result before loading to table 
select $1
from @util_db.public.my_internal_stage/json_book_author_nested.json
(file_format => library_card_catalog.public.json_file_format);

-- Load to table usin the format for json 
copy into library_card_catalog.public.nested_ingest_json 
from @util_db.public.my_internal_stage
files = ('json_book_author_nested.json')
file_format = ( format_name = library_card_catalog.public.json_file_format );

-- Query the Nested JSON Data
-- all data 
select raw_nested_book
from library_card_catalog.public.nested_ingest_json;

-- year of book 
select raw_nested_book:year_published
from library_card_catalog.public.nested_ingest_json;

-- authors 
select raw_nested_book:authors
from library_card_catalog.public.nested_ingest_json;

-- Use these example flatten commands to explore flattening the nested book and author data
select value:first_name
from library_card_catalog.public.nested_ingest_json
,lateral flatten(input => raw_nested_book:authors);

select value:first_name
from library_card_catalog.public.nested_ingest_json
,table(flatten(raw_nested_book:authors));

//Add a CAST command to the fields returned
SELECT value:first_name::varchar, value:last_name::varchar
from library_card_catalog.public.nested_ingest_json
,lateral flatten(input => raw_nested_book:authors);

//Assign new column  names to the columns using "AS"
select value:first_name::varchar as first_nm
, value:last_name::varchar as last_nm
from library_card_catalog.public.nested_ingest_json
,lateral flatten(input => raw_nested_book:authors);